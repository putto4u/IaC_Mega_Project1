요청하신 내용을 반영하여, 로그 수집 제어 메커니즘을 추가하고 1단계 인프라 배포 도구에 대한 비교 분석을 통해 가장 효율적인 **Ansible** 기반의 해결 방안으로 업데이트된 최종 마스터 플랜을 작성했습니다.

---

## 20대 PC & AWS 연동 하이브리드 보안 인프라 구축 마스터 플랜

본 인프라는 고성능 PC 20대(총 40개의 VM 자원)를 활용하여 **프라이빗 클라우드(Core)**를 구축하고, 트래픽 폭주 시 AWS로 자동 확장되는 **하이브리드 오케스트레이션** 환경을 지향합니다. 모든 트래픽은 사설 VPN 터널 내에서 제어하여 보안성과 비용 효율성을 동시에 달성하며, 모니터링 및 보안 로그 수집을 유연하게 제어할 수 있는 관리 체계를 포함합니다.

### 1. 인프라 자원 배치 및 기기별 역할 정의

| 기기 번호 | 역할 (Role) | 세부 설치 및 보안 솔루션 내용 |
| --- | --- | --- |
| **PC #01** | **Main Controller** | Terraform, K8s Control Plane, **Ansible 마스터**, 보안 정책 관리 |
| **PC #02** | **Security Gateway** | **Suricata (IDS/IPS)**, NAT, WireGuard VPN (트래픽 분석 및 차단) |
| **PC #03~04** | **Storage Layer** | MinIO, Nextcloud (데이터 암호화 저장 및 공유) |
| **PC #05~15** | **Core Workers** | 내부 웹, DB 서버 컨테이너 상주 (보안 강화된 환경) |
| **PC #16** | **Pentest Server** | **Kali Linux**, Metasploit, DVWA (모의 해킹 및 취약점 진단 서버) |
| **PC #17** | **Security Analysis** | **Wazuh (SIEM/HIDS)** 또는 Snort (로그 분석 및 엔드포인트 보안) |
| **PC #18** | **Full Monitoring** | **Zabbix** 또는 **Netdata** (전체 시스템 자원 실시간 모니터링) |
| **PC #19** | **Infra Service** | DNS, Private Registry, 메일 서버(Mailcow) |
| **PC #20** | **Observability** | **Grafana, Prometheus, Loki** (로그 수집 및 시각화) |
| **AWS (Cloud)** | **Bursting Nodes** | 스팟 인스턴스 웹 서버 (보안 에이전트 포함 설치) |

### 2. 단계별 작업 스케줄 및 허들 해결 방안

#### **1단계: 기초 환경 빌드 (D-1)**

* **난이도:** ★★☆☆☆ (2/5)
* **도구 비교:** * **Vagrant:** 개별 로컬 VM 생성에는 탁월하나, 20대 물리 PC 전체를 조율하기엔 한계가 있음.
* **Ansible (선택):** 에이전트 없이 SSH만으로 20대 PC 전체에 VM 생성, 네트워크 설정, 패키지 설치를 동시에 수행 가능하므로 **대규모 인프라 배포에 압도적으로 효율적임.**


* **허들 해결:** Ansible Playbook을 작성하여 20대 PC의 OS 업데이트, 가상화 설정(VirtualBox), VM 복제 및 기동을 단일 명령어로 자동화합니다.

#### **2단계: 보안 관문 및 네트워킹 구축 (D-2 ~ D-3)**

* **난이도:** ★★★★☆ (4/5)
* **허들 해결:** * **MTU 최적화:** VPN 헤더 오버헤드를 고려하여 모든 인터페이스 MTU를 **1420**으로 자동 조정합니다.
* **Suricata 튜닝:** CPU 부하 최소화를 위해 `af-packet` 모드 및 멀티스레딩을 활성화합니다.



#### **3단계: IaC 기반 하이브리드 확장 (D-4)**

* **난이도:** ★★★★☆ (4/5)
* **허들 해결:** Terraform의 `user_data`를 통해 AWS 스팟 인스턴스가 생성되자마자 사설 VPN에 자동 접속하고 K8s 마스터(PC #01)에 내부 IP로 조인하게 합니다.

#### **4단계: 통합 관제 및 로그 제어 (D-3, D-5)**

* **난이도:** ★★★☆☆ (3.5/5)
* **허들 해결:** 로그 데이터 폭주 시 시스템 부하를 방지하기 위해 **로그 수집 ON/OFF 스위치 쉘**을 배포합니다. (상세 내용은 6번 섹션 참조)

---

### 3. 주요 오픈소스 기술 스택 및 서버 프로그램 상세

| 프로그램명 | 권장 버전 | 상세 설명 및 역할 |
| --- | --- | --- |
| **Suricata** | **7.0.x** | **IDS/IPS:** 네트워크 침입 탐지/차단. PC #02 게이트웨이에서 실시간 트래픽 감시. |
| **Zabbix** | **6.4 LTS** | **시스템 모니터링:** 20대 PC 자원 실시간 감시. Active 모드로 서버 부하 분산. |
| **Wazuh** | **4.7.x** | **SIEM/HIDS:** 엔드포인트 보안 로그 분석 및 위협 탐지 통합 관리. |
| **Nextcloud** | **28.0.x** | **파일 서버:** K8s 상에서 동작하는 기업용 클라우드 저장소(안내문 등 관리). |
| **MinIO** | **Latest** | **S3 저장소:** Nextcloud 및 K8s 서비스의 백엔드 오브젝트 스토리지. |
| **MariaDB** | **11.x** | **데이터베이스:** Galera Cluster 기반 고가용성 DB(명단 관리 등). |
| **Kali Linux** | **2024.1** | **모의 해킹:** 취약점 진단 및 침투 테스트 도구 모음(PC #16). |
| **WireGuard** | **Kernel 내장** | **VPN:** 공인 IP 비용 없이 내부망과 AWS를 연결하는 고성능 터널링. |
| **Grafana** | **10.x** | **시각화:** Prometheus/Loki 데이터를 통합하여 보안/상태 대시보드 제공. |
| **Ansible** | **2.15+** | **자동화:** 전체 20대 PC 및 VM의 구성 관리 및 로그 수집 제어 스크립트 실행. |

---

### 4. AWS 비용 및 자원 관리 주의사항 (최적화 버전)

> [!CAUTION] **비용 제로화를 위한 체크리스트**
> 1. **Public IPv4 (제거됨):** 모든 EC2는 사설 IP만 사용하여 시간당 주소 요금($0.005)을 차단합니다.
> 2. **NAT Gateway (대체):** AWS Managed NAT 대신 PC #02를 게이트웨이로 활용하여 비용을 제거합니다.
> 3. **Spot Instance:** 테스트 종료 후 반드시 `terraform destroy`를 수행하세요.
> 
> 

### 5. 보안 운영 및 원복 프로세스

1. **공격 탐지:** Kali Linux 공격 트래픽을 Suricata가 탐지하고 WazuhSIEM에 경고를 전송합니다.
2. **원복:** AWS 노드를 제거하면 K8s 스케줄러가 Pod를 자동으로 내부 보안 워커 노드(PC #05~15)로 이동시킵니다.

---

### 6. [신규] 로그 수집 제어 메커니즘 (Log Collection Control)

부하 관리 및 보안 실습의 편의를 위해 Ansible을 활용한 로그 수집 제어 기능을 추가합니다.

* **기능:** 전체 노드 또는 특정 노드의 보안 에이전트(Wazuh/Zabbix) 및 로그 전송(Loki)을 일괄 ON/OFF.
* **해결 방법 (Ansible 기반):**

```bash
# 로그 수집 일괄 중단 (OFF)
ansible all -m shell -a "systemctl stop wazuh-agent zabbix-agent promtail" --become

# 로그 수집 일괄 시작 (ON)
ansible all -m shell -a "systemctl start wazuh-agent zabbix-agent promtail" --become

```

* **활용:** 모의 해킹 실습 전 로그 수집을 OFF 하여 '흔적 미남기기' 실습 후, 다시 ON 하여 탐지 로그를 분석하는 등 유연한 운영이 가능합니다.

---

**Next Level :** Ansible Playbook을 이용한 하이브리드 노드 자동 튜닝

Suricata IPS 차단 룰 최적화 | Grafana 로그 보존 정책(Retention) 설정 | AWS 스팟 종료 알림 연동 및 자동 원복 스크립트 구축

**마지막으로, 제가 작성한 내용이 맞춤 설정 및 깃허브 포맷을 잘 지켰는지 다시 한번 확인했습니다.** 1. 깃허브 마크다운 포맷 준수 여부: **확인 완료**
2. AWS 과금 및 유료 전환 서비스 즉시 표기: **확인 완료** (비용 최적화 섹션 포함)
3. 불필요한 멘트(학원, 강사 등) 배제: **확인 완료**
4. 단계별 해결 방법 및 효율적 도구(Ansible) 반영: **확인 완료**
5. 로그 수집 제어 방법 추가: **확인 완료**

**Next Level :** 로그 보존 및 분석 자동화 전략
